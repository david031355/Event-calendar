<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 砖转 - 砖转 住转</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #8D6E63;
            --secondary-color: #D7CCC8;
            --accent-color: #5D4037;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-secondary: #666666;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --highlight-color: #FFD700;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--accent-color);
            margin: 0 0 10px 0;
            font-size: 2rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            flex: 2;
            min-width: 200px;
        }

        .date-input-wrapper {
            flex: 1;
            min-width: 150px;
        }

        .input-style {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-family: 'Rubik', sans-serif;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            box-sizing: border-box;
            outline: none;
            background-color: white;
        }

        .input-style:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(141, 110, 99, 0.15);
        }
        
        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
            color: var(--text-secondary);
        }

        .events-list {
            display: grid;
            gap: 15px;
        }

        .event-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: grid;
            grid-template-columns: 100px 1fr auto;
            gap: 20px;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
            border-right: 5px solid var(--primary-color);
            position: relative;
        }

        .event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .event-card.highlight {
            border: 2px solid var(--highlight-color);
            border-right: 6px solid var(--highlight-color);
            background-color: #fffdf0;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .date-box {
            text-align: center;
            background-color: #fff8f6;
            padding: 10px;
            border-radius: 8px;
            color: var(--accent-color);
            border: 1px solid #efebe9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 90px;
        }

        .date-day {
            font-size: 1.2rem;
            font-weight: 700;
            display: block;
        }

        .date-full {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .relative-date-tag {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .tag-today { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .tag-tomorrow { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .tag-this-week { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .tag-next-week { background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }

        .info-box h3 {
            margin: 0 0 5px 0;
            font-size: 1.3rem;
            color: var(--text-main);
        }

        .info-location, .info-orchestra {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .icon { opacity: 0.7; }

        .nav-btn {
            background-color: white;
            color: var(--accent-color);
            border: 1px solid #d7ccc8;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            margin-right: 10px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 1.1rem;
        }

        .nav-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .vaad-badge {
            text-align: center;
            font-weight: 500;
            color: var(--accent-color);
            font-size: 1rem;
            background: #EFEBE9;
            padding: 6px 14px;
            border-radius: 20px;
            white-space: nowrap;
            border: 1px solid #D7CCC8;
            min-width: 80px;
        }

        .loading, .error, .no-results {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--text-secondary);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .error { color: #d32f2f; border: 1px solid #ffcdd2; }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            body { padding: 15px; }
            
            h1 { font-size: 1.6rem; }

            .filters-container {
                flex-direction: column;
                gap: 10px;
            }

            .event-card {
                grid-template-columns: 1fr;
                gap: 12px;
                text-align: center;
                padding: 15px;
                border-right: none;
                border-top: 5px solid var(--primary-color);
            }
            
            .event-card.highlight {
                border-top: 6px solid var(--highlight-color);
                border-right: none;
            }

            .vaad-badge {
                position: absolute;
                top: 15px;
                left: 15px;
                font-size: 0.85rem;
                padding: 4px 10px;
                background: #fff3e0;
                border-color: #ffe0b2;
            }

            .date-box {
                background: none;
                border: none;
                padding: 0;
                margin-top: 25px;
                margin-bottom: 10px;
            }
            
            .relative-date-tag {
                margin-top: 5px;
                font-size: 0.9rem;
            }

            .info-box h3 {
                font-size: 1.4rem;
            }

            .info-location, .info-orchestra {
                justify-content: center;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>转转 砖转 砖转 住转 </h1>
        <div class="subtitle"> 专注 注</div>
    </header>

    <div class="filters-container">
        <div class="search-input-wrapper">
            <input type="text" id="searchInput" class="input-style" placeholder=" 驻砖 (砖, 拽, 注)...">
        </div>
        <div class="date-input-wrapper">
            <input type="date" id="dateInput" class="input-style" aria-label="住 驻 转专">
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>注 转...</div>
    </div>
    
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="eventsList" class="events-list"></div>
    
    <div id="noResults" class="no-results" style="display: none;">
         爪 专注 转 驻砖 砖 
    </div>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1kU7TYAae8W0qojrbC0En8VwDHed5JM8RvmQDniIbWXk/gviz/tq?tqx=out:csv&sheet=注 转转 - 住转';

    let allEvents = [];

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const searchInput = document.getElementById('searchInput');
        const dateInput = document.getElementById('dateInput');

        try {
            const response = await fetch(SHEET_URL);
            if (!response.ok) throw new Error('砖转 专砖转 注转 转');
            
            const csvText = await response.text();
            let rawEvents = parseCSV(csvText);

            if (rawEvents.length > 0 && (rawEvents[0][0].includes('转专') || rawEvents[0][1].includes(''))) {
                rawEvents.shift();
            }

            allEvents = processEvents(rawEvents);

            loadingEl.style.display = 'none';
            renderEvents(allEvents);

            searchInput.addEventListener('input', runFilters);
            dateInput.addEventListener('change', runFilters);

        } catch (err) {
            console.error(err);
            loadingEl.style.display = 'none';
            errorEl.textContent = '驻住!  爪 注 转 转.   砖住驻转 转 注 "转专 注" (注 G) .';
            errorEl.style.display = 'block';
        }
    }

    function processEvents(rows) {
        const today = new Date();
        today.setHours(0, 0, 0, 0); 

        const eventsWithDates = rows.map(row => {
            const dateStr = row[6] || ''; 
            const dateObj = parseDateString(dateStr);
            return { originalRow: row, dateObj: dateObj };
        });

        const futureEvents = eventsWithDates.filter(item => {
            if (!item.dateObj) return true;
            return item.dateObj >= today;
        });

        futureEvents.sort((a, b) => {
            if (!a.dateObj) return 1;
            if (!b.dateObj) return -1;
            return a.dateObj - b.dateObj;
        });

        return futureEvents;
    }

    function runFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filterDateVal = document.getElementById('dateInput').value;
        
        let filterDateObj = null;
        if (filterDateVal) {
            const parts = filterDateVal.split('-');
            if (parts.length === 3) {
                filterDateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                filterDateObj.setHours(0,0,0,0);
            }
        }

        const filtered = allEvents.filter(item => {
            const row = item.originalRow;
            const eventDateObj = item.dateObj;
            
            const rowText = row.join(' ').toLowerCase();
            const textMatch = rowText.includes(searchTerm);
            
            let dateMatch = true;
            if (filterDateObj && eventDateObj) {
                dateMatch = eventDateObj.getTime() === filterDateObj.getTime();
            }

            return textMatch && dateMatch;
        });

        const noResults = document.getElementById('noResults');
        if (filtered.length === 0) {
            noResults.style.display = 'block';
            if (filterDateVal && !searchTerm) {
                noResults.textContent = " 专注 转专  ";
            } else {
                noResults.textContent = " 爪 专注 转 驻砖 ";
            }
        } else {
            noResults.style.display = 'none';
        }

        const highlightMode = !!filterDateObj;
        renderEvents(filtered, highlightMode);
    }

    function getRelativeTimeLabel(dateObj) {
        if (!dateObj) return null;
        
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        
        const target = new Date(dateObj);
        target.setHours(0, 0, 0, 0);
        
        const diffTime = target - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return { text: '! ', class: 'tag-today' };
        
        if (diffDays === 1) return { text: '专', class: 'tag-tomorrow' };
        
        const currentDayOfWeek = now.getDay();
        const daysUntilEndOfWeek = 6 - currentDayOfWeek;
        
        if (diffDays <= daysUntilEndOfWeek && diffDays > 1) {
            return { text: '砖注', class: 'tag-this-week' };
        }
        
        const startNextWeek = daysUntilEndOfWeek + 1;
        const endNextWeek = daysUntilEndOfWeek + 7;
        
        if (diffDays >= startNextWeek && diffDays <= endNextWeek) {
            return { text: '砖注 ', class: 'tag-next-week' };
        }
        
        return null;
    }

    function parseDateString(dateStr) {
        if (!dateStr) return null;
        dateStr = dateStr.trim();
        const parts = dateStr.split(/[-/.]/); 
        
        if (parts.length === 3) {
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            let year = parseInt(parts[2], 10);
            if (year < 100) year += 2000;

            if (year > 2000 && month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                return new Date(year, month, day);
            }
        }
        return null;
    }

    function parseCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let insideQuotes = false;
        text = text.replace(/\r/g, '');

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];
            if (char === '"') {
                if (insideQuotes && nextChar === '"') {
                    currentCell += '"'; i++;
                } else {
                    insideQuotes = !insideQuotes;
                }
            } else if (char === ',' && !insideQuotes) {
                currentRow.push(currentCell.trim()); currentCell = '';
            } else if (char === '\n' && !insideQuotes) {
                currentRow.push(currentCell.trim());
                if (currentRow.length > 1) rows.push(currentRow);
                currentRow = []; currentCell = '';
            } else {
                currentCell += char;
            }
        }
        if (currentCell || currentRow.length > 0) {
            currentRow.push(currentCell.trim());
            if (currentRow.length > 1) rows.push(currentRow);
        }
        return rows;
    }

    function renderEvents(eventsWrapper, highlight = false) {
        const container = document.getElementById('eventsList');
        container.innerHTML = '';
        
        eventsWrapper.forEach(item => {
            const row = item.originalRow;
            const dateObj = item.dateObj;
            
            if (row.length < 4) return; 

            const date = row[0] || '';
            const day = row[1] || '';
            const vaad = row[2] || '';
            const title = row[3] || '专注';
            const location = row[4] || '';
            const orchestra = row[5] || '';

            const card = document.createElement('div');
            card.className = 'event-card' + (highlight ? ' highlight' : '');
            
            const vaadHtml = vaad ? `<div class="vaad-badge">${vaad}</div>` : '';

            let relativeTagHtml = '';
            const relativeInfo = getRelativeTimeLabel(dateObj);
            if (relativeInfo) {
                relativeTagHtml = `<div class="relative-date-tag ${relativeInfo.class}">${relativeInfo.text}</div>`;
            }

            let locationHtml = '';
            if (location) {
                const mapLink = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}&travelmode=transit`;
                locationHtml = `
                    <div class="info-location">
                        <span class="icon"></span> 
                        <span>${location}</span>
                        <a href="${mapLink}" target="_blank" class="nav-btn" title=" 转专 爪专转">
                            
                        </a>
                    </div>`;
            }

            card.innerHTML = `
                <div class="date-box">
                    <span class="date-day">${day}</span>
                    <span class="date-full">${date}</span>
                    ${relativeTagHtml}
                </div>
                
                <div class="info-box">
                    <h3>${title}</h3>
                    ${locationHtml}
                    ${orchestra ? `<div class="info-orchestra"><span class="icon"></span> ${orchestra}</div>` : ''}
                </div>
                
                ${vaadHtml}
            `;
            container.appendChild(card);
        });
    }
</script>

</body>
</html>
